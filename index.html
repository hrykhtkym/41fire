<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>バーコード買物計算ツール</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="stylesheet" href="./styles.css" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="計算ツール">
  <!-- iOSホーム画面アイコンは必要に応じて追加 -->
</head>
<body>
  <header class="app-bar">
    <h1>買物スキャン</h1>
    <div class="spacer"></div>
    <button id="installBtn" class="btn ghost" hidden>インストール</button>
  </header>

  <main>
    <section class="scanner">
      <div class="video-wrap">
        <video id="video" autoplay playsinline muted></video>
        <div class="reticle"></div>
      </div>
      <div class="controls">
        <button id="startBtn" class="btn primary">カメラ起動</button>
        <button id="stopBtn" class="btn" disabled>停止</button>
        <button id="manualBtn" class="btn">手入力</button>
      </div>
      <p id="status" class="status">準備完了</p>
    </section>

    <section class="cart">
      <div class="cart-header">
        <h2>カート</h2>
        <div class="cart-actions">
          <label class="tax">税率
            <input type="number" id="taxRate" min="0" max="100" step="0.1" value="10" />%
          </label>
          <label class="round">端数処理
            <select id="rounding">
              <option value="ceil" selected>切り上げ</option>
              <option value="round">四捨五入</option>
              <option value="floor">切り捨て</option>
            </select>
          </label>
          <button id="clearCartBtn" class="btn warn">カートを空にする</button>
        </div>
      </div>
      <ul id="cartList" class="cart-list"></ul>
      <div class="totals">
        <div><span>小計</span><span id="subtotal">¥0</span></div>
        <div><span>消費税</span><span id="tax">¥0</span></div>
        <div class="grand"><span>合計</span><span id="total">¥0</span></div>
      </div>
    </section>

    <section class="catalog">
      <details>
        <summary>カタログ（catalog.json）</summary>
        <p>catalog.json の内容が使用されます。未登録のバーコードは都度入力できます。</p>
        <button id="exportCatalogBtn" class="btn">現在のカタログをエクスポート</button>
        <input id="importCatalogInput" type="file" accept="application/json" />
      </details>
    </section>
  </main>

  <!-- 割引入力モーダル -->
  <dialog id="discountDialog">
    <form method="dialog" id="discountForm">
      <h3>割引を設定</h3>
      <p id="discountProduct"></p>
      <div class="field">
        <label>
          種別
          <select id="discountType">
            <option value="none">なし</option>
            <option value="percent">%（パーセント）</option>
            <option value="amount">¥（金額）</option>
          </select>
        </label>
      </div>
      <div class="field">
        <label>
          値
          <input id="discountValue" type="number" inputmode="decimal" step="0.1" min="0" value="0" />
        </label>
      </div>
      <menu>
        <button value="cancel" class="btn">キャンセル</button>
        <button value="ok" class="btn primary">適用</button>
      </menu>
    </form>
  </dialog>

  <!-- 価格・商品名入力モーダル -->
  <dialog id="itemInputDialog">
    <form method="dialog" id="itemInputForm">
      <h3>商品情報を入力</h3>
      <p id="itemBarcode"></p>
      <div class="field">
        <label>商品名
          <input id="itemName" type="text" required />
        </label>
      </div>
      <div class="field">
        <label>価格（税抜・¥）
          <input id="itemPrice" type="number" inputmode="numeric" min="0" step="1" required />
        </label>
      </div>
      <menu>
        <button value="cancel" class="btn">キャンセル</button>
        <button value="ok" class="btn primary">保存</button>
      </menu>
    </form>
  </dialog>

  <script type="module" src="./app.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(console.warn);
      });
    }
  </script>
</body>
<style>
/* 小さな内蔵スタイル（早期表示用） */
body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif; margin: 0; color: #0b1324; }
.app-bar { display:flex; align-items:center; gap:8px; padding:12px 16px; background:#0ea5e9; color:#fff; position:sticky; top:0; z-index:10; }
.app-bar h1{ font-size:18px; margin:0; }
.spacer{ flex:1; }
.btn{ padding:8px 12px; border-radius:8px; border:1px solid #cfd8e3; background:#fff; color:#0b1324; }
.btn.primary{ background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
.btn.warn{ background:#fee2e2; color:#991b1b; border-color:#fecaca; }
.btn.ghost{ background:transparent; color:#fff; border-color:rgba(255,255,255,0.6); }
main{ padding:12px; display:grid; gap:16px; }
.video-wrap{ position:relative; background:#000; border-radius:12px; overflow:hidden; }
video{ width:100%; height:auto; display:block; }
.reticle{ position:absolute; inset:10% 15%; border:2px dashed rgba(255,255,255,0.7); border-radius:10px; }
.controls{ display:flex; gap:8px; margin-top:8px; }
.status{ color:#475569; font-size:14px; margin:6px 2px; }
.cart-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.cart-actions{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
.cart-list{ list-style:none; padding:0; margin:0; display:grid; gap:8px; }
.cart-item{ display:grid; grid-template-columns: 1fr auto auto auto auto; align-items:center; gap:8px; padding:8px; border:1px solid #e2e8f0; border-radius:10px; }
.cart-item .name{ font-weight:600; }
.cart-item input[type=number]{ width:70px; }
.cart-item .yen{ text-align:right; min-width:80px; }
.totals{ margin-top:8px; display:grid; gap:6px; }
.totals > div{ display:flex; justify-content:space-between; }
.totals .grand{ font-weight:700; font-size:18px; }
dialog{ border:none; border-radius:12px; padding:16px; }
dialog::backdrop{ background:rgba(0,0,0,0.3); }
.field{ margin:8px 0; display:block; }
label{ display:flex; gap:8px; align-items:center; }
summary{ cursor:pointer; }
</style>
</html>

